!function(e){function t(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function i(e){var i=e.length;if(16>i)return!1;var r,o=Infinity,n=-Infinity,a=Infinity,s=-Infinity;for(r=0;r<i-1;r+=2)o=Math.min(o,e[r]),n=Math.max(n,e[r]),a=Math.min(a,e[r+1]),s=Math.max(s,e[r+1]);if(.85>(n=(r=n-o)/(s-=a))||1.15<n)return!1;for(o={x:o+r/2,y:a+s/2},a=(r=(r+s)/4)*r,r=0;r<i-1;r+=2)if(.8>(s=t({x:e[r],y:e[r+1]},o))/a||1.2<s/a)return!1;return!0}function r(e,t){var i={};e/=f;var r,o=K;return r=0>=(t/=f)?90:1<=t?-90:(2*T(H(W*(1-2*t)))-X)/W*180,i[o]=r,i[Q]=360*(1===e?1:(e%1+1)%1)-180,i}function o(e,t){var i=z(1,R(0,.5-M(A(U+X*e/180))/W/2));return{x:(t/360+.5)*f<<0,y:i*f<<0}}function n(e){for(var t=ee+oe,i=te+ne,r=0,o=e.length-3;r<o;r+=2)if(e[r]>oe&&e[r]<t&&e[r+1]>ne&&e[r+1]<i)return!0;return!1}function a(){g||(g=setInterval(function(){for(var e=xe.items,t=!1,i=0,r=e.length;i<r;i++)1>e[i].scale&&(e[i].scale+=.1,1<e[i].scale&&(e[i].scale=1),t=!0);ke.render(),t||(clearInterval(g),g=null)},33))}function s(e){d=ie+e.x,p=te+e.y,ke.render(!0)}function h(e){ee=e.width,te=e.height,re=te/2<<0,d=ie=ee/2<<0,p=te,ke.setSize(ee,te),u=ye-50}function l(e){f=Y<<(c=e);var t=o((e=r(oe+ie,ne+re)).latitude,0);ue=o(e.latitude,1).x-t.x,de=D(.95,c-$),le=""+ae.alpha(de),ce=""+se.alpha(de),fe=""+he.alpha(de)}var c,f,u,d,p,y,g,x,m,v,b,w,_,S,C,k,H=(F=Math).exp,M=F.log,P=F.sin,I=F.cos,A=F.tan,T=F.atan,j=F.atan2,z=F.min,R=F.max,O=F.sqrt,E=F.ceil,D=F.pow,Z=Z||Array,B=B||Array,F=/iP(ad|hone|od)/g.test(navigator.userAgent),N=!!~navigator.userAgent.indexOf("Trident"),G=!e.requestAnimationFrame||F||N?function(e){e()}:e.requestAnimationFrame,V=function(){function e(e,t,i){return 0>i&&(i+=1),1<i&&(i-=1),i<1/6?e+6*(t-e)*i:.5>i?t:i<2/3?e+(t-e)*(2/3-i)*6:e}var t={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},i=function(e,t,i,r){this.H=e,this.S=t,this.L=i,this.A=r};return i.parse=function(e){var i,r=0,o=0,n=0,a=1;if(e=(""+e).toLowerCase(),i=(e=t[e]||e).match(/^#(\w{2})(\w{2})(\w{2})$/))r=parseInt(i[1],16),o=parseInt(i[2],16),n=parseInt(i[3],16);else{if(!(i=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;r=parseInt(i[1],10),o=parseInt(i[2],10),n=parseInt(i[3],10),a=i[4]?parseFloat(i[5]):1}return this.fromRGBA(r,o,n,a)},i.fromRGBA=function(e,t,r,o){"object"==typeof e?(t=e.g/255,r=e.b/255,o=e.a,e=e.r/255):(e/=255,t/=255,r/=255);var n,a=Math.max(e,t,r),s=Math.min(e,t,r),h=(a+s)/2,l=a-s;if(l){switch(s=.5<h?l/(2-a-s):l/(a+s),a){case e:n=(t-r)/l+(t<r?6:0);break;case t:n=(r-e)/l+2;break;case r:n=(e-t)/l+4}n*=60}else n=s=0;return new i(n,s,h,o)},i.prototype={toRGBA:function(){var t,i=Math.min(360,Math.max(0,this.H)),r=Math.min(1,Math.max(0,this.S)),o=Math.min(1,Math.max(0,this.L)),n=Math.min(1,Math.max(0,this.A));if(0===r)i=t=r=o;else{var a=.5>o?o*(1+r):o+r-o*r;r=e(o=2*o-a,a,(i=i/360)+1/3);t=e(o,a,i),i=e(o,a,i-1/3)}return{r:Math.round(255*r),g:Math.round(255*t),b:Math.round(255*i),a:n}},toString:function(){var e=this.toRGBA();return 1===e.a?"#"+(16777216+(e.r<<16)+(e.g<<8)+e.b).toString(16).slice(1,7):"rgba("+[e.r,e.g,e.b,e.a.toFixed(2)].join()+")"},hue:function(e){return new i(this.H*e,this.S,this.L,this.A)},saturation:function(e){return new i(this.H,this.S*e,this.L,this.A)},lightness:function(e){return new i(this.H,this.S,this.L*e,this.A)},alpha:function(e){return new i(this.H,this.S,this.L,this.A*e)}},i}(),q=(x=Math,m=x.PI,v=x.sin,b=x.cos,w=x.tan,_=x.asin,S=x.atan2,k=23.4397*(C=m/180),function(e,t,i){i=C*-i,t*=C,e=e.valueOf()/864e5-.5+2440588-2451545;var r,o=C*(357.5291+.98560028*e);return r=o+(r=C*(1.9148*v(o)+.02*v(2*o)+3e-4*v(3*o)))+102.9372*C+m,o=_(v(0)*b(k)+b(0)*v(k)*v(r)),r=S(v(r)*b(k)-w(0)*v(k),b(r)),e=C*(280.16+360.9856235*e)-i-r,{altitude:i=_(v(t)*v(o)+b(t)*b(o)*b(e)),azimuth:(t=S(v(e),b(e)*v(t)-w(o)*b(t)))-m/2}}),J=function(){function e(e){return"#"===(e=e.toLowerCase())[0]?e:r[o[e]||e]||null}function t(e,t){var i,r,o,s,h,l=0;for(s=0,h=e.length-3;s<h;s+=2)i=e[s],r=e[s+1],o=e[s+2],l+=i*e[s+3]-o*r;if((0<l/2?n:a)===t)return e;for(i=[],r=e.length-2;0<=r;r-=2)i.push(e[r],e[r+1]);return i}function i(e){var r,o,s,h=[];switch(e.type){case"GeometryCollection":for(h=[],r=0,o=e.geometries.length;r<o;r++)(s=i(e.geometries[r]))&&h.push.apply(h,s);return h;case"MultiPolygon":for(h=[],r=0,o=e.coordinates.length;r<o;r++)(s=i({type:"Polygon",coordinates:e.coordinates[r]}))&&h.push.apply(h,s);return h;case"Polygon":e=e.coordinates;break;default:return[]}var l,c=[],f=[];for(r=0,o=(l=e[0]).length;r<o;r++)c.push(l[r][1],l[r][0]);for(c=t(c,n),r=0,o=e.length-1;r<o;r++){for(l=e[r+1],f[r]=[],h=0,s=l.length;h<s;h++)f[r].push(l[h][1],l[h][0]);f[r]=t(f[r],a)}return[{outer:c,inner:f.length?f:null}]}var r={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},o={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},n="CW",a="CCW";return{read:function(t){if(!t||"FeatureCollection"!==t.type)return[];var r,o,n,a,s,h,l,c,f=[];for(r=0,o=(t=t.features).length;r<o;r++)if("Feature"===(s=t[r]).type&&!1!==He(s)){switch(n=(n=s.properties)||{},(a={}).height=n.height||(n.levels?3*n.levels:pe),a.minHeight=n.minHeight||(n.minLevel?3*n.minLevel:0),(h=n.material?e(n.material):n.wallColor||n.color)&&(a.wallColor=h),(h=n.roofMaterial?e(n.roofMaterial):n.roofColor)&&(a.roofColor=h),n.shape){case"cylinder":case"cone":case"dome":case"sphere":a.shape=n.shape,a.isRotational=!0;break;case"pyramid":a.shape=n.shape}switch(n.roofShape){case"cone":case"dome":a.roofShape=n.roofShape,a.isRotational=!0;break;case"pyramid":a.roofShape=n.roofShape}for(a.roofShape&&n.roofHeight?(a.roofHeight=n.roofHeight,a.height=R(0,a.height-a.roofHeight)):a.roofHeight=0,l=a,n=0,a=(h=i(s.geometry)).length;n<a;n++){c=l;var u={},d=void 0;for(d in c)c.hasOwnProperty(d)&&(u[d]=c[d]);if((c=u).footprint=h[n].outer,c.isRotational){u=c;for(var p=180,y=-180,g=0,x=(d=c.footprint).length;g<x;g+=2)p=z(p,d[g+1]),y=R(y,d[g+1]);u.radius=(y-p)/2}h[n].inner&&(c.holes=h[n].inner),(s.id||s.properties.id)&&(c.id=s.id||s.properties.id),s.properties.relationId&&(c.relationId=s.properties.relationId),f.push(c)}}return f}}}(),W=Math.PI,X=W/2,U=W/4,Y=256,$=15,K="latitude",Q="longitude",ee=0,te=0,ie=0,re=0,oe=0,ne=0,ae=V.parse("rgba(200, 190, 180)"),se=ae.lightness(.8),he=ae.lightness(1.2),le=""+ae,ce=""+se,fe=""+he,ue=0,de=1,pe=5,ye=450,ge=function(){function e(e,n){if(!t[e]){var a=new XMLHttpRequest;return a.onreadystatechange=function(){if(4===a.readyState&&a.status&&!(200>a.status||299<a.status)&&n&&a.responseText){var s=a.responseText;for(t[e]=s,i.push({url:e,size:s.length}),r+=s.length,n(s);r>o;)s=i.shift(),r-=s.size,delete t[s.url]}},a.open("GET",e),a.send(null),a}n&&n(t[e])}var t={},i=[],r=0,o=5242880;return{loadJSON:function(t,i){return e(t,function(e){var t;try{t=JSON.parse(e)}catch(r){}i(t)})}}}(),xe={loadedItems:{},items:[],getPixelFootprint:function(e){for(var t,i=new Z(e.length),r=0,n=e.length-1;r<n;r+=2)t=o(e[r],e[r+1]),i[r]=t.x,i[r+1]=t.y;n=(i=(e=i).length/2)-1;var a,s,h,l,c=[],f=[],u=[];for((t=new B(i))[r=0]=t[n]=1;n;){for(s=0,a=r+1;a<n;a++){h=e[2*a];var d=e[2*a+1],p=e[2*r],y=e[2*r+1],g=e[2*n],x=e[2*n+1],m=g-p,v=x-y,b=void 0;0===m&&0===v||(1<(b=((h-p)*m+(d-y)*v)/(m*m+v*v))?(p=g,y=x):0<b&&(p+=m*b,y+=v*b)),(h=(m=h-p)*m+(v=d-y)*v)>s&&(l=a,s=h)}2<s&&(t[l]=1,c.push(r),f.push(l),c.push(l),f.push(n)),r=c.pop(),n=f.pop()}for(a=0;a<i;a++)t[a]&&u.push(e[2*a],e[2*a+1]);if(!(8>(i=u).length))return i},resetItems:function(){this.items=[],this.loadedItems={},Ce.reset()},addRenderItems:function(e,t){for(var i,r,o,n=J.read(e),s=0,h=n.length;s<h;s++)o=(i=n[s]).id||[i.footprint[0],i.footprint[1],i.height,i.minHeight].join(),!this.loadedItems[o]&&(r=this.scale(i))&&(r.scale=t?0:1,this.items.push(r),this.loadedItems[o]=1);a()},scale:function(e){var t={},r=6/D(2,c-$);if(e.id&&(t.id=e.id),t.height=z(e.height/r,u),t.minHeight=isNaN(e.minHeight)?0:e.minHeight/r,!(t.minHeight>u)&&(t.footprint=this.getPixelFootprint(e.footprint),t.footprint)){for(var o=t.footprint,n=Infinity,a=-Infinity,s=Infinity,h=-Infinity,l=0,f=o.length-3;l<f;l+=2)n=z(n,o[l]),a=R(a,o[l]),s=z(s,o[l+1]),h=R(h,o[l+1]);if(t.center={x:n+(a-n)/2<<0,y:s+(h-s)/2<<0},e.radius&&(t.radius=e.radius*ue),e.shape&&(t.shape=e.shape),e.roofShape&&(t.roofShape=e.roofShape),"cone"!==t.roofShape&&"dome"!==t.roofShape||t.shape||!i(t.footprint)||(t.shape="cylinder"),e.holes){t.holes=[];var d;for(o=0,n=e.holes.length;o<n;o++)(d=this.getPixelFootprint(e.holes[o]))&&t.holes.push(d)}var p;if(e.wallColor&&(p=V.parse(e.wallColor))&&(p=p.alpha(de),t.altColor=""+p.lightness(.8),t.wallColor=""+p),e.roofColor&&(p=V.parse(e.roofColor))&&(t.roofColor=""+p.alpha(de)),e.relationId&&(t.relationId=e.relationId),t.hitColor=Ce.idToColor(e.relationId||e.id),t.roofHeight=isNaN(e.roofHeight)?0:e.roofHeight/r,!(t.height+t.roofHeight<=t.minHeight))return t}},set:function(e){this.isStatic=!0,this.resetItems(),this._staticData=e,this.addRenderItems(this._staticData,!0)},load:function(e,t){this.src=e||"http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json".replace("{k}",t||"anonymous"),this.update()},update:function(){function e(e){a.addRenderItems(e)}if(this.resetItems(),!(c<$))if(this.isStatic&&this._staticData)this.addRenderItems(this._staticData);else if(this.src){var t,i=oe/(n=16<c?256<<c-16:256>>16-c)<<0,r=ne/n<<0,o=E((oe+ee)/n),n=E((ne+te)/n),a=this;for(t=r;t<=n;t++)for(r=i;r<=o;r++)this.loadTile(r,t,16,e)}},loadTile:function(e,t,i,r){return e=this.src.replace("{s}","abcd"[(e+t)%4]).replace("{x}",e).replace("{y}",t).replace("{z}",i),ge.loadJSON(e,r)}},me={draw:function(e,t,i,r,o,n,a,s){var h,l=this._extrude(e,t,r,o,n,a),c=[];if(i)for(t=0,h=i.length;t<h;t++)c[t]=this._extrude(e,i[t],r,o,n,a);if(e.fillStyle=s,e.beginPath(),this._ring(e,l),i)for(t=0,h=c.length;t<h;t++)this._ring(e,c[t]);e.closePath(),e.stroke(),e.fill()},_extrude:function(e,t,i,r,o,n){i=ye/(ye-i);for(var a,s,h=ye/(ye-r),l={x:0,y:0},c={x:0,y:0},f=[],u=0,d=t.length-3;u<d;u+=2)l.x=t[u]-oe,l.y=t[u+1]-ne,c.x=t[u+2]-oe,c.y=t[u+3]-ne,a=we.project(l,i),s=we.project(c,i),r&&(l=we.project(l,h),c=we.project(c,h)),(c.x-l.x)*(a.y-l.y)>(a.x-l.x)*(c.y-l.y)&&(e.fillStyle=l.x<c.x&&l.y<c.y||l.x>c.x&&l.y>c.y?n:o,e.beginPath(),this._ring(e,[c.x,c.y,l.x,l.y,a.x,a.y,s.x,s.y]),e.closePath(),e.fill()),f[u]=a.x,f[u+1]=a.y;return f},_ring:function(e,t){e.moveTo(t[0],t[1]);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i],t[i+1])},simplified:function(e,t,i){if(e.beginPath(),this._ringAbs(e,t),i){t=0;for(var r=i.length;t<r;t++)this._ringAbs(e,i[t])}e.closePath(),e.stroke(),e.fill()},_ringAbs:function(e,t){e.moveTo(t[0]-oe,t[1]-ne);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-oe,t[i+1]-ne)},shadow:function(e,t,i,r,o){for(var n,a,s=null,h={x:0,y:0},l={x:0,y:0},c=0,f=t.length-3;c<f;c+=2)h.x=t[c]-oe,h.y=t[c+1]-ne,l.x=t[c+2]-oe,l.y=t[c+3]-ne,n=Se.project(h,r),a=Se.project(l,r),o&&(h=Se.project(h,o),l=Se.project(l,o)),(l.x-h.x)*(n.y-h.y)>(n.x-h.x)*(l.y-h.y)?(1===s&&e.lineTo(h.x,h.y),s=0,c||e.moveTo(h.x,h.y),e.lineTo(l.x,l.y)):(0===s&&e.lineTo(n.x,n.y),s=1,c||e.moveTo(n.x,n.y),e.lineTo(a.x,a.y));if(i)for(c=0,f=i.length;c<f;c++)this._ringAbs(e,i[c])},shadowMask:function(e,t,i){if(this._ringAbs(e,t),i){t=0;for(var r=i.length;t<r;t++)this._ringAbs(e,i[t])}},hitArea:function(e,t,i,r,o,n){i=null;var a={x:0,y:0},s={x:0,y:0};r=ye/(ye-r);var h,l=ye/(ye-o);e.fillStyle=n,e.beginPath();for(var c=0,f=t.length-3;c<f;c+=2)a.x=t[c]-oe,a.y=t[c+1]-ne,s.x=t[c+2]-oe,s.y=t[c+3]-ne,n=we.project(a,r),h=we.project(s,r),o&&(a=we.project(a,l),s=we.project(s,l)),(s.x-a.x)*(n.y-a.y)>(n.x-a.x)*(s.y-a.y)?(1===i&&e.lineTo(a.x,a.y),i=0,c||e.moveTo(a.x,a.y),e.lineTo(s.x,s.y)):(0===i&&e.lineTo(n.x,n.y),i=1,c||e.moveTo(n.x,n.y),e.lineTo(h.x,h.y));e.closePath(),e.fill()}},ve={draw:function(e,t,i,r,o,n,a,s,h){t={x:t.x-oe,y:t.y-ne};var l=ye/(ye-o),c=ye/(ye-n);o=we.project(t,l),r*=l,n&&(t=we.project(t,c),i*=c),(l=this._tangents(t,i,o,r))?(n=j(l[0].y1-t.y,l[0].x1-t.x),l=j(l[1].y1-t.y,l[1].x1-t.x)):(n=1.5*W,l=1.5*W),e.fillStyle=a,e.beginPath(),e.arc(o.x,o.y,r,X,n,!0),e.arc(t.x,t.y,i,n,X),e.closePath(),e.fill(),e.fillStyle=s,e.beginPath(),e.arc(o.x,o.y,r,l,X,!0),e.arc(t.x,t.y,i,X,l),e.closePath(),e.fill(),e.fillStyle=h,this._circle(e,o,r)},simplified:function(e,t,i){this._circle(e,{x:t.x-oe,y:t.y-ne},i)},shadow:function(e,t,i,r,o,n){var a;t={x:t.x-oe,y:t.y-ne},o=Se.project(t,o),n&&(t=Se.project(t,n));var s=this._tangents(t,i,o,r);s?(n=j(s[0].y1-t.y,s[0].x1-t.x),a=j(s[1].y1-t.y,s[1].x1-t.x),e.moveTo(s[1].x2,s[1].y2),e.arc(o.x,o.y,r,a,n),e.arc(t.x,t.y,i,n,a)):(e.moveTo(t.x+i,t.y),e.arc(t.x,t.y,i,0,2*W))},shadowMask:function(e,t,i){var r=t.x-oe;t=t.y-ne,e.moveTo(r+i,t),e.arc(r,t,i,0,2*W)},hitArea:function(e,t,i,r,o,n,a){t={x:t.x-oe,y:t.y-ne};var s=ye/(ye-o),h=ye/(ye-n);o=we.project(t,s),r*=s,n&&(t=we.project(t,h),i*=h),n=this._tangents(t,i,o,r),e.fillStyle=a,e.beginPath(),n?(a=j(n[0].y1-t.y,n[0].x1-t.x),s=j(n[1].y1-t.y,n[1].x1-t.x),e.moveTo(n[1].x2,n[1].y2),e.arc(o.x,o.y,r,s,a),e.arc(t.x,t.y,i,a,s)):(e.moveTo(t.x+i,t.y),e.arc(t.x,t.y,i,0,2*W)),e.closePath(),e.fill()},_circle:function(e,t,i){e.beginPath(),e.arc(t.x,t.y,i,0,2*W),e.stroke(),e.fill()},_tangents:function(e,t,i,r){if(!((c=(s=e.x-i.x)*s+(h=e.y-i.y)*h)<=(l=t-r)*l)){var o,n,a,s=-s/(c=O(c)),h=-h/c,l=l/c,c=[];o=O(R(0,1-l*l));for(var f=1;-1<=f;f-=2)n=s*l-f*o*h,a=h*l+f*o*s,c.push({x1:e.x+t*n<<0,y1:e.y+t*a<<0,x2:i.x+r*n<<0,y2:i.y+r*a<<0});return c}}},be={draw:function(e,t,i,r,o,n,a){var s=ye/(ye-o);i=we.project({x:i.x-oe,y:i.y-ne},ye/(ye-r)),r={x:0,y:0};for(var h={x:0,y:0},l=0,c=t.length-3;l<c;l+=2)r.x=t[l]-oe,r.y=t[l+1]-ne,h.x=t[l+2]-oe,h.y=t[l+3]-ne,o&&(r=we.project(r,s),h=we.project(h,s)),(h.x-r.x)*(i.y-r.y)>(i.x-r.x)*(h.y-r.y)&&(e.fillStyle=r.x<h.x&&r.y<h.y||r.x>h.x&&r.y>h.y?a:n,e.beginPath(),this._triangle(e,r,h,i),e.closePath(),e.fill())},_triangle:function(e,t,i,r){e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.lineTo(r.x,r.y)},_ring:function(e,t){e.moveTo(t[0]-oe,t[1]-ne);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-oe,t[i+1]-ne)},shadow:function(e,t,i,r,o){var n={x:0,y:0},a={x:0,y:0};i=Se.project({x:i.x-oe,y:i.y-ne},r),r=0;for(var s=t.length-3;r<s;r+=2)n.x=t[r]-oe,n.y=t[r+1]-ne,a.x=t[r+2]-oe,a.y=t[r+3]-ne,o&&(n=Se.project(n,o),a=Se.project(a,o)),(a.x-n.x)*(i.y-n.y)>(i.x-n.x)*(a.y-n.y)&&this._triangle(e,n,a,i)},shadowMask:function(e,t){this._ring(e,t)},hitArea:function(e,t,i,r,o,n){var a=ye/(ye-o);i=we.project({x:i.x-oe,y:i.y-ne},ye/(ye-r)),r={x:0,y:0};var s={x:0,y:0};e.fillStyle=n,e.beginPath(),n=0;for(var h=t.length-3;n<h;n+=2)r.x=t[n]-oe,r.y=t[n+1]-ne,s.x=t[n+2]-oe,s.y=t[n+3]-ne,o&&(r=we.project(r,a),s=we.project(s,a)),(s.x-r.x)*(i.y-r.y)>(i.x-r.x)*(s.y-r.y)&&this._triangle(e,r,s,i);e.closePath(),e.fill()}},we={project:function(e,t){return{x:(e.x-d)*t+d<<0,y:(e.y-p)*t+p<<0}},render:function(){var e=this.context;if(e.clearRect(0,0,ee,te),!(c<$||y)){var i,r,o,a,s,h,l,f={x:d+oe,y:p+ne},u=xe.items;u.sort(function(e,i){return e.minHeight-i.minHeight||t(i.center,f)-t(e.center,f)||i.height-e.height});for(var g=0,x=u.length;g<x;g++)if(i=u[g],!_e.isSimple(i)&&n(a=i.footprint)){switch(r=1>i.scale?i.height*i.scale:i.height,o=0,i.minHeight&&(o=1>i.scale?i.minHeight*i.scale:i.minHeight),s=i.wallColor||le,h=i.altColor||ce,l=i.roofColor||fe,e.strokeStyle=h,i.shape){case"cylinder":ve.draw(e,i.center,i.radius,i.radius,r,o,s,h,l);break;case"cone":ve.draw(e,i.center,i.radius,0,r,o,s,h);break;case"dome":ve.draw(e,i.center,i.radius,i.radius/2,r,o,s,h);break;case"sphere":ve.draw(e,i.center,i.radius,i.radius,r,o,s,h,l);break;case"pyramid":be.draw(e,a,i.center,r,o,s,h);break;default:me.draw(e,a,i.holes,r,o,s,h,l)}switch(i.roofShape){case"cone":ve.draw(e,i.center,i.radius,0,r+i.roofHeight,r,l,""+V.parse(l).lightness(.9));break;case"dome":ve.draw(e,i.center,i.radius,i.radius/2,r+i.roofHeight,r,l,""+V.parse(l).lightness(.9));break;case"pyramid":be.draw(e,a,i.center,r+i.roofHeight,r,l,V.parse(l).lightness(.9))}}}}},_e={maxZoom:$+2,maxHeight:5,isSimple:function(e){return c<=this.maxZoom&&e.height+e.roofHeight<this.maxHeight},render:function(){var e=this.context;if(e.clearRect(0,0,ee,te),!(c<$||y||c>this.maxZoom))for(var t,i,r=xe.items,o=0,a=r.length;o<a;o++)if(!((t=r[o]).height>=this.maxHeight)&&n(i=t.footprint))switch(e.strokeStyle=t.altColor||ce,e.fillStyle=t.roofColor||fe,t.shape){case"cylinder":case"cone":case"dome":case"sphere":ve.simplified(e,t.center,t.radius);break;default:me.simplified(e,i,t.holes)}}},Se={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(e,t){return{x:e.x+this.direction.x*t,y:e.y+this.direction.y*t}},render:function(){var e,t,i,o=this.context;if(o.clearRect(0,0,ee,te),!(!this.enabled||c<$||y||(e=r(ie+oe,re+ne),e=q(this.date,e.latitude,e.longitude),0>=e.altitude))){var a,s,h,l;for(i=5>(t=1/A(e.altitude))?.75:1/t*5,this.direction.x=I(e.azimuth)*t,this.direction.y=P(e.azimuth)*t,e=xe.items,o.canvas.style.opacity=i/(2*de),o.shadowColor=this.blurColor,o.shadowBlur=de/2*this.blurSize,o.fillStyle=this.color,o.beginPath(),i=0,t=e.length;i<t;i++)if(n(l=(a=e[i]).footprint)){switch(s=1>a.scale?a.height*a.scale:a.height,h=0,a.minHeight&&(h=1>a.scale?a.minHeight*a.scale:a.minHeight),a.shape){case"cylinder":ve.shadow(o,a.center,a.radius,a.radius,s,h);break;case"cone":ve.shadow(o,a.center,a.radius,0,s,h);break;case"dome":ve.shadow(o,a.center,a.radius,a.radius/2,s,h);break;case"sphere":ve.shadow(o,a.center,a.radius,a.radius,s,h);break;case"pyramid":be.shadow(o,l,a.center,s,h);break;default:me.shadow(o,l,a.holes,s,h)}switch(a.roofShape){case"cone":ve.shadow(o,a.center,a.radius,0,s+a.roofHeight,s);break;case"dome":ve.shadow(o,a.center,a.radius,a.radius/2,s+a.roofHeight,s);break;case"pyramid":be.shadow(o,l,a.center,s+a.roofHeight,s)}}for(o.closePath(),o.fill(),o.shadowBlur=null,o.globalCompositeOperation="destination-out",o.beginPath(),i=0,t=e.length;i<t;i++)if(n(l=(a=e[i]).footprint)&&!a.minHeight)switch(a.shape){case"cylinder":case"cone":case"dome":ve.shadowMask(o,a.center,a.radius);break;default:me.shadowMask(o,l,a.holes)}o.fillStyle="#00ff00",o.fill(),o.globalCompositeOperation="source-over"}}},Ce={_idMapping:[null],reset:function(){this._idMapping=[null]},render:function(){if(!this._timer){var e=this;this._timer=setTimeout(function(){e._timer=null,e._render()},500)}},_render:function(){var e=this.context;if(e.clearRect(0,0,ee,te),!(c<$||y)){var i,r,o,a,s,h={x:d+oe,y:p+ne},l=xe.items;l.sort(function(e,i){return e.minHeight-i.minHeight||t(i.center,h)-t(e.center,h)||i.height-e.height});for(var f=0,u=l.length;f<u;f++)if((s=(i=l[f]).hitColor)&&n(a=i.footprint)){switch(r=i.height,o=0,i.minHeight&&(o=i.minHeight),i.shape){case"cylinder":ve.hitArea(e,i.center,i.radius,i.radius,r,o,s);break;case"cone":ve.hitArea(e,i.center,i.radius,0,r,o,s);break;case"dome":ve.hitArea(e,i.center,i.radius,i.radius/2,r,o,s);break;case"sphere":ve.hitArea(e,i.center,i.radius,i.radius,r,o,s);break;case"pyramid":be.hitArea(e,a,i.center,r,o,s);break;default:me.hitArea(e,a,i.holes,r,o,s)}switch(i.roofShape){case"cone":ve.hitArea(e,i.center,i.radius,0,r+i.roofHeight,r,s);break;case"dome":ve.hitArea(e,i.center,i.radius,i.radius/2,r+i.roofHeight,r,s);break;case"pyramid":be.hitArea(e,a,i.center,r+i.roofHeight,r,s)}}ee&&te&&(this._imageData=this.context.getImageData(0,0,ee,te).data)}},getIdFromXY:function(e,t){var i=this._imageData;if(i){var r=4*((0|t)*ee+(0|e));return this._idMapping[i[r]|i[r+1]<<8|i[r+2]<<16]}},idToColor:function(e){var t=this._idMapping.indexOf(e);return-1===t&&(this._idMapping.push(e),t=this._idMapping.length-1),"rgb("+[255&t,t>>8&255,t>>16&255].join()+")"}},ke={container:document.createElement("DIV"),items:[],init:function(){this.container.style.pointerEvents="none",this.container.style.position="absolute",this.container.style.left=0,this.container.style.top=0,Se.context=this.createContext(this.container),_e.context=this.createContext(this.container),we.context=this.createContext(this.container),Ce.context=this.createContext()},render:function(e){G(function(){e||(Se.render(),_e.render(),Ce.render()),we.render()})},createContext:function(e){var t=document.createElement("CANVAS");t.style.transform="translate3d(0, 0, 0)",t.style.imageRendering="optimizeSpeed",t.style.position="absolute",t.style.left=0,t.style.top=0;var i=t.getContext("2d");return i.lineCap="round",i.lineJoin="round",i.lineWidth=1,i.imageSmoothingEnabled=!1,this.items.push(t),e&&e.appendChild(t),i},appendTo:function(e){e.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(e,t){for(var i=0,r=this.items.length;i<r;i++)this.items[i].width=e,this.items[i].height=t},setPosition:function(e,t){this.container.style.left=e+"px",this.container.style.top=t+"px"}};ke.init(),(N=(F=function(e){this.offset={x:0,y:0},e&&e.addLayer(this)}).prototype=L.Layer?new L.Layer:{}).addTo=function(e){return e.addLayer(this),this},N.onAdd=function(e){this.map=e,ke.appendTo(e._panes.overlayPane);var t=this.getOffset(),i=e.getPixelOrigin();h({width:e._size.x,height:e._size.y});var r=i.y-t.y;oe=i.x-t.x,ne=r,l(e._zoom),ke.setPosition(-t.x,-t.y),e.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.on("zoomanim",this.onZoom,this),e.attributionControl&&e.attributionControl.addAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'),xe.update()},N.onRemove=function(){var e=this.map;e.attributionControl&&e.attributionControl.removeAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'),e.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.off("zoomanim",this.onZoom,this),ke.remove()},N.onMove=function(e){e=this.getOffset(),s({x:this.offset.x-e.x,y:this.offset.y-e.y})},N.onMoveEnd=function(e){if(this.noMoveEnd)this.noMoveEnd=!1;else{var t=this.map;e=this.getOffset();var i=t.getPixelOrigin();this.offset=e,ke.setPosition(-e.x,-e.y),s({x:0,y:0}),h({width:t._size.x,height:t._size.y}),t=i.y-e.y,oe=i.x-e.x,ne=t,ke.render(),xe.update()}},N.onZoomStart=function(){y=!0,ke.render()},N.onZoom=function(){},N.onZoomEnd=function(e){e=this.map;var t=this.getOffset(),i=e.getPixelOrigin(),r=i.y-t.y;oe=i.x-t.x,ne=r,e=e._zoom,y=!1,l(e),xe.update(),ke.render(),this.noMoveEnd=!0},N.onResize=function(){},N.onViewReset=function(){var e=this.getOffset();this.offset=e,ke.setPosition(-e.x,-e.y),s({x:0,y:0})},N.onClick=function(e){var t=Ce.getIdFromXY(e.containerPoint.x,e.containerPoint.y);t&&Me({feature:t,lat:e.latlng.lat,lon:e.latlng.lng})},N.getOffset=function(){return L.DomUtil.getPosition(this.map._mapPane)},N.style=function(e){var t;return(t=(e=e||{}).color||e.wallColor)&&(ae=V.parse(t),le=""+ae.alpha(de),se=ae.lightness(.8),ce=""+se.alpha(de),he=ae.lightness(1.2),fe=""+he.alpha(de)),e.roofColor&&(he=V.parse(e.roofColor),fe=""+he.alpha(de)),void 0!==e.shadows&&(Se.enabled=!!e.shadows),ke.render(),this},N.date=function(e){return Se.date=e,Se.render(),this},N.load=function(e){return xe.load(e),this},N.set=function(e){return xe.set(e),this};var He=function(){};N.each=function(e){return He=function(t){return e(t)},this};var Me=function(){};N.click=function(e){return Me=function(t){return e(t)},this},F.VERSION="0.2.2b",F.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>',e.OSMBuildings=F}(this);